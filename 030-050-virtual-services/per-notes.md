# 030-050-virtual-services

 For this demo, first we'll change the weight of our reviews application between its different versions. Then, we'll create some routing rules so that different users will see different versions of our application. To be able to change the weight of traffic between different versions of an app, first we need to define those versions. This can be done by using Destination Rules, as we've talked earlier. For this demo, we can use the default Destination Rules from our Samples folder. Then, let's create our Virtual Service. This virtual service will be named Revu's, and it will be affecting Revu's host. Under the HTTP route section, we have created two different destinations. First is for subset v1, that is defined by a Destination Rule. Second is for subset v2, and that is also defined by a Destination Rule. And you can see, there's a weight distribution by 75 to 25 here. These numbers always need to be 100 when summed up. We can apply this YAML now. Let's check with Analyze if it's all good. Yes, it's all looking good. Now, let's create some traffic to our application to see how this change in weight will affect it. Switching back to Kiali for that, we can check the Istio configs. Here are the Destination Rules we created from the Samples folder. As you can see, there are three different subsets that will be matched by the services' labels, version v1, v2, and v3. Let's check out Revu's Virtual Service. You can see the weight distribution in this bar on the right. Now, let's see the graph. As you can see, the weight of all Review service is distributed between v1 and v2. When we go to the app, it shows that there is only a no star and a black star version. Red star version is v3, and it is not there. Now, let's stop the loop that we have the traffic coming from and try to feel the 75-25% difference in the browser. As you can see, v1 is more prominent than v2. I've just stopped the other traffic source, so the balance might not be very clear right now, but you can see the difference. Now, let's change our weight distribution once more, but this time we'll do this using the Kiali interface. This time, I'm adding another destination, but I'm not changing any weights, so it will be 125 in total. Let's see how it will go. As you can see, Kiali interface did not let me save this, and it has given me a proper error on the x at the top. Let's fix this weight distribution. And also, I want another subset, v3, here. So, as you can see, first we had only two versions of reviews, and we now, even for a small percentage of requests, introduced another version of it. We can check it in the browser, and it is not common, but we've started to see some red stars in some of the requests. Let's go back to the terminal and create some heavy traffic here. As you can see, v3 is also in our graph now. There are different graph versions here, some show them grouped as services, some show them grouped as workloads. Let's check Istio Virtual Services config. Here on the right, you can see the new weight distribution. If you click hosts, you can also see the overview of the hosts. Well, in this detailed graph, it will give us some more information about weight distribution. As you can see, reviews version 1 traffic is almost three times more than version 2 and version 3, as we've configured it. Now, let's try the example we used in the lecture. Let's try to distribute traffic by 99% to 1%. Yes, version 1 and version 2 okay. We can remove version 3. This probably will take some time. Okay, we've waited a bit, and as you can see, the weight of reviews version 1 traffic has changed drastically. And it will probably change some more over time. And also in the browser, we cannot see the second version, almost at all. Ah, there it is. Now, let's do another example. Let's remove the other destination. We want some of our users to see some specific versions of our app. For example, our product owner might have said, everyone has a non-star version, but for a special user group called KodeKloud, they want to release a starred version of our app, which is a very nice and rich feature. And let's add a new section under HTTP for that, called match. When KodeKloud user signs in, they'll see the black star version, and the rest of the users will see the regular one. To do that, we'll now add a rule. This rule will pick the requests that have end user in the request header, and it will check if it's matching exactly with KodeKloud. If a request passes this rule, it will be routed to reviews version 2. And the rest will be routed to reviews version 1. But how do we create a request that has KodeKloud end user in the request header? Don't worry about it. We have a feature in our application. See the tiny sign-in button on the top? That's for adding an end user header to the request. We'll just type our username and write a random password, then sign in. There's actually nothing this app does in terms of checking this user. It is just for experimenting with request headers. Once you sign in, you'll see the reviews version has changed to version 2. And it is not related to a weight distribution rule at all. I keep refreshing, but the page is still the same. However, when I sign out, it changes back to version 1, just as we configured it to do. Now, we are happy with this. But we also want to introduce a new version for a specific group of people, and we want them to test it, and they can even give us some feedback. For this, let's create another match section. And give a very secret name to these users as test users. And route that traffic to our newest, very colorful version, version 3. As you can see, the bar on the right shows both three routes are 100% in weight, once they've matched our rules. Now, let's try the default version without signing in. Yes, it's a no-star version, version 1. Let's try if our new version is available to test user. It is working, and there is nothing else the test user can see. And KodeKloud user is still seeing the Blackstar version with no problem at all. Virtual Services are powerful, and as we've just experienced, they can help you manage your traffic with much flexibility.